<html>
<head>
    {% block head %}
    <link rel="stylesheet" type="text/css" href="/statics/libs/css/buttons.css">
    <link rel="stylesheet" type="text/css" href="/statics/libs/fontawesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.select/1.12.2/css/bootstrap-select.min.css">
    <link rel="stylesheet" type="text/css" href="{{static_url('style.css')}}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree@3.3.4/dist/themes/default/style.min.css">
    {% end %}

    {% block title %}{% end %}
    <style type="text/css">
        {% block style %}
        .left_block {
            float: left;
            width: 300px;
        }
        .dump-screen {
            float: right;
            width: 90%;
        }
        .my-frame {
            float: right;
            width: 75%;
            height: 1px;
        }

        button:active {
          background-color: #4cade5;
          box-shadow: 0 2px #999;
          transform: translateY(4px);
        }
        {%end%}
    </style>
</head>
<body>
{% extends "index.html" %}
{% block body %}
<div class="row">
<div class="am-u-sm-12 am-u-md-12 am-u-lg-12">
    <div class="widget am-cf">
       <div class="widget-body  widget-body-lg am-fr">
           <div class="left_block">
               <div class="device-screen" id="screen_div">
               </div>
               <div class="device-key" style="margin-top: 5px;display: inline-flex; justify-content: space-between; width:100%">
                <button style="width: 14%;margin-left: 2%" onclick="clickBtn('power')">
                    <svg class="icon" viewBox="0 0 1024 1024"  width="24" height="24"><path d="M512 525.933714c20.571429 0 34.285714-14.994286 34.285714-36.425143V104.649143c0-21.869714-13.714286-36.425143-34.285714-36.425143S477.257143 82.779429 477.257143 104.649143V489.508571c0 21.412571 14.153143 36.425143 34.724571 36.425143z m0 429.860572c232.722286 0 426.002286-192.859429 426.002286-425.581715 0-126.427429-56.996571-241.28-146.578286-319.268571-35.565714-31.725714-86.564571 18.413714-45.860571 53.979429 73.289143 63.853714 119.149714 159.433143 119.149714 265.289142 0 195.858286-157.293714 353.152-352.731429 353.152A352.091429 352.091429 0 0 1 158.866286 530.212571c0-105.856 46.299429-200.996571 119.588571-265.289142 40.283429-35.565714-10.733714-85.705143-45.860571-53.997715-89.581714 78.006857-146.578286 192.859429-146.578286 319.286857C85.997714 762.934857 279.277714 955.794286 512 955.794286z"></path></svg>
                </button>
                <button style="width: 14%;margin-left: 2%" onclick="clickBtn('recent')">
                    <svg class="icon" viewBox="0 0 1024 1024" width="24" height="24"><path d="M672 85.333333a96 96 0 0 1 95.786667 89.429334L768 181.333333v31.957334L842.666667 213.333333a96 96 0 0 1 95.786666 89.429334L938.666667 309.333333v405.333334a96 96 0 0 1-89.429334 95.786666L842.666667 810.666667H768v32a96 96 0 0 1-89.429333 95.786666L672 938.666667h-320a96 96 0 0 1-95.786667-89.429334L256 842.666667V810.666667H181.333333a96 96 0 0 1-95.786666-89.429334L85.333333 714.666667v-405.333334a96 96 0 0 1 89.429334-95.786666L181.333333 213.333333 256 213.290667V181.333333a96 96 0 0 1 89.429333-95.786666L352 85.333333h320z m0 64h-320a32 32 0 0 0-31.701333 27.648L320 181.333333v661.333334c0 16.213333 12.032 29.610667 27.648 31.701333l4.352 0.298667h320a32 32 0 0 0 31.701333-27.648l0.298667-4.352V181.333333a32 32 0 0 0-27.648-31.701333L672 149.333333zM256 277.290667L181.333333 277.333333a32 32 0 0 0-31.701333 27.648L149.333333 309.333333v405.333334c0 16.213333 12.032 29.610667 27.648 31.701333l4.352 0.298667H256V277.290667z m586.666667 0.042666L768 277.290667V746.666667h74.666667a32 32 0 0 0 31.701333-27.648l0.298667-4.352v-405.333334a32 32 0 0 0-32-32z"></path></svg>
                </button>
                <button style="width: 14%;margin-left: 2%" onclick="clickBtn('home')">
                    <svg class="icon" viewBox="0 0 1024 1024" width="24" height="24"><path d="M937.067069 482.335377 556.719504 106.839307c-1.89107-2.251274-6.123464-6.173606-11.997242-10.048867-9.889231-6.522554-21.093411-10.486842-33.388435-10.486842-13.137205 0-24.610514 3.984754-34.245965 10.590196-5.826705 3.997034-9.844206 8.076956-12.117992 11.117199L85.643566 482.381425c-14.653745 14.434757-14.653745 37.890982 0 52.358485 14.538111 14.380522 33.883715 8.316409 50.366108-7.919367L161.532977 501.587859l350.847693-339.869664 374.329501 368.073007c20.077268 13.223163 37.773302 17.377786 50.358945 4.946662C951.720813 520.273431 951.720813 496.801856 937.067069 482.335377z" fill="#272636" p-id="19850"></path><path d="M793.007045 462.046285c-17.391089 0-31.567973 13.938454-31.634488 31.236422l0 0.085958 0 0.089028 0 350.143659c0 17.416671-14.371312 31.602765-32.119535 31.602765l-84.129072 0 0-192.166671c0-49.818639-40.803311-90.111321-91.14486-90.111321l-85.268012 0c-50.326199 0-91.143836 40.300868-91.143836 90.111321l0 192.166671L293.437146 875.204116c-17.750269 0-32.119535-14.186094-32.119535-31.602765L261.317611 493.391177c-0.033769-17.355273-14.21884-31.343869-31.611975-31.343869-17.418718 0-31.589462 13.96506-31.658024 31.302937l0 354.429265c0 49.844222 40.808428 90.133833 91.14486 90.133833l141.253094 0 10.389628 0 0-10.391674 0-240.262062c0-17.410532 14.365172-31.580253 32.119535-31.580253l76.801177 0c17.756409 0 32.119535 14.169721 32.119535 31.580253l0 240.262062 0 10.391674 10.391674 0 141.253094 0c50.321082 0 91.14486-40.297798 91.14486-90.133833L824.665069 493.322615C824.527946 475.958132 810.380738 462.046285 793.007045 462.046285z"></path></svg>                </button>
                <button style="width: 14%;margin-left: 2%" onclick="clickBtn('back')">
                    <svg class="icon" viewBox="0 0 1024 1024"  width="24" height="24"><path d="M853.333333 245.333333H245.333333l93.866667-93.866666c12.8-12.8 12.8-34.133333 0-46.933334-12.8-12.8-34.133333-12.8-46.933333 0l-145.066667 145.066667c-12.8 12.8-12.8 34.133333 0 46.933333l145.066667 145.066667c6.4 6.4 14.933333 10.666667 23.466666 10.666667s17.066667-4.266667 23.466667-10.666667c12.8-12.8 12.8-34.133333 0-46.933333L256 311.466667h597.333333c6.4 0 10.666667 4.266667 10.666667 10.666666v426.666667c0 6.4-4.266667 10.666667-10.666667 10.666667H170.666667c-17.066667 0-32 14.933333-32 32s14.933333 32 32 32h682.666666c40.533333 0 74.666667-34.133333 74.666667-74.666667V320c0-40.533333-34.133333-74.666667-74.666667-74.666667z" fill="#000000" p-id="18850"></path></svg>
                </button>
                <button style="width: 14%;margin-left: 2%" onclick="clickBtn('unlock')">
                    <svg class="icon" viewBox="0 0 1024 1024" width="24" height="24"><path d="M512 768c-17.664 0-32-14.304-32-32v-96c0-17.696 14.336-32 32-32s32 14.304 32 32v96c0 17.696-14.336 32-32 32z" p-id="14944"></path><path d="M832 960H192c-52.928 0-96-43.072-96-96V480c0-52.928 43.072-96 96-96h640c52.928 0 96 43.072 96 96v384c0 52.928-43.072 96-96 96zM192 448c-17.632 0-32 14.368-32 32v384c0 17.664 14.368 32 32 32h640c17.664 0 32-14.336 32-32V480c0-17.632-14.336-32-32-32H192z" p-id="14945"></path><path d="M288 416c-17.664 0-32-14.336-32-32v-64.672c0-160.064 135.392-255.744 266.304-255.744 100.672 0 198.72 59.872 244.032 148.992 8 15.744 1.728 35.008-14.016 43.04-15.776 8-35.04 1.696-43.04-14.016-34.656-68.16-109.792-113.984-186.976-113.984C422.848 127.584 320 199.296 320 319.328V384c0 17.664-14.336 32-32 32z"></path></svg>
                </button>
                <button style="width: 14%;margin-left: 2%" onclick="dumpAction()">
                    <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2132" width="24" height="24"><path d="M933.308465 890.723577l-146.767692-157.046802c59.488883-71.644737 92.202958-160.954809 92.202958-254.974136 0-220.566488-179.481767-400.048255-400.110677-400.048255-220.566488 0-400.048255 179.451068-400.048255 400.048255s179.481767 400.048255 400.078954 400.048255c57.796334-0.030699 113.530706-12.094456 165.633365-35.82288 15.479553-7.04751 22.312168-25.297153 15.264659-40.74703-7.04751-15.511275-25.38925-22.373567-40.74703-15.264659-44.101427 20.066011-91.249237 30.252001-140.181693 30.2827-186.652074 0-338.498434-151.845337-338.498434-338.498434 0-186.621375 151.845337-338.498434 338.498434-338.498434 186.682773 0 338.559832 151.845337 338.559832 338.498434 0 87.863117-33.514301 171.111123-94.326319 234.415914-11.786441 12.248975-11.387351 31.729655 0.830925 43.516096 0.923022 0.892323 2.12336 1.231037 3.170203 2.000564 0.830925 1.231037 1.261737 2.64627 2.308579 3.75451L888.346437 932.700621c6.03239 6.493901 14.248516 9.756201 22.465664 9.756201 7.53972 0 15.07944-2.739391 21.019733-8.309246C944.234305 922.606729 944.910711 903.126049 933.308465 890.723577z" fill="#272636" p-id="2133"></path></svg>
                </button>
               </div>

               <div class="input-box">
                    <input class="input-text" type="text" id="apk-url" value="输入安装APK url"
                    onfocus="if(value=='输入安装APK url')value=''"
                    onblur="if(!value)value='输入安装APK url'">
                    <img src="/statics/assets/icon/install.svg" class="input-icon" id="install" title="安装应用">
               </div>
               <div class="input-box" style="height: 60px">
                    <input class="input-text" type="text" id="activity" value="com.kevin.testool/.activity.MainActivity"
                    onfocus="if(value=='com.kevin.testool/.activity.MainActivity')value=''"
                    onblur="if(!value)value='com.kevin.testool/.activity.MainActivity'">
                   <div style="margin-left: 1%; width: 28px">
                    <img src="/statics/assets/icon/arrow_right.svg" class="input-icon" id="start-activity" title="start activity">
                    <img src="/statics/assets/icon/arrow_left.svg" class="input-icon" id="get-activity" title="get activity">
                   </div>
               </div>

           </div>
           <div class="my-frame">
           </div>
           <div class="dump-screen"></div>

       </div>
     </div>
</div>
</div>
<script src="/statics/ace/ace.js"></script>
<script src="/statics/ace/mode-python.js"></script>
<script src="{{static_url('libs/vue-2.5.16/vue.js')}}"></script>
<script src="{{static_url('bootstrap/js/bootstrap.min.js')}}"></script>
<script src="{{static_url('js/common.js')}}"></script>
<script src="{{static_url('js/jstree.min.js')}}"></script>
<script src="{{static_url('js/index2.js')}}"></script>
<script>
    var ip = getQueryString("ip");
    var device_id = getQueryString("device_id");
    var websocket;
    var base64Str;
    var imgWidth = 'width:100%';
    var wsurl = "ws:" + ip + ":9999";
    var startPoint;
    var endPoint;
    var startTime;
    var endtTime;
    var isActive = true;
    var isConnecting = false;
    let timer = null;
    $(function() {
            startWebSocket();
            $("#screen_div").mousedown(function () {
                startPoint = getRelativePoint();
                startTime = new Date().getTime();
            });
            $("#screen_div").mouseup(function () {
                endPoint = getRelativePoint();
                endtTime = new Date().getTime();
                if (startPoint[0] > 1 || startPoint[1] > 1 ){

                } else {
                    let action = parseAction(startPoint[0], startPoint[1], endPoint[0], endPoint[1], endtTime - startTime);
                    send("action", action);
                }
            });
            $("#install").on("click", function () {
                let apk_url = $("#apk-url").val();
                if (apk_url.length > 0 && apk_url !== "输入安装APK url"){
                    send("action", {"install":apk_url});
                }
            });
            $("#start-activity").on("click", function () {
                let activity = $("#activity").val();
                if (activity.length > 0 && activity !== "activity"){
                    send("action", {"activity":activity});
                }
            });
            $("#get-activity").on("click", function () {
                send("activity", "");
            });
            window.onmousemove = function(){
                clearTimeout(timer);
                if (!isActive && !isConnecting) {
                    // console.log("鼠标移动")
                    startWebSocket();
                }
                timer = setTimeout(function(){ //鼠标静止20s后连接关闭
                    websocket.close();
                },20000);
            }
        });

    /*
    窗口激活状态判断
    */
    window.onblur = function(e){
            // websocket.close();
	        console.log("窗口处于未激活状态！")
    }
    window.onfocus = function(e){
            startWebSocket();
            console.log("窗口处于激活状态！")
    }

    /*
    开始websocket服务
    */
    function startWebSocket() {
        //连接Socket的URL地址
        if (window.WebSocket) { //判断浏览器是否支持websocket
            websocket = new WebSocket(wsurl);
            console.log("======websocket开始连接======")
            isConnecting = true;
            websocket.onopen = function(event) {
                console.log("======连接成功======")
                isActive = true;
                isConnecting = false;
                send("screen", "");
                //恢复界面色彩
                $("#screen_div").css({ "-webkit-filter": "","-moz-filter": "","-ms-filter": "","-o-filter": "","filter": ""})
                //更新设备状态为占用
                let content = JSON.stringify(
                {device_id:device_id, device_ip:ip, idle:"false"}, null, 2
                );
                $.post("/test/device_state", content, function(data, status){
                    if(status === "success"){
                        // console.log(data);
                    } else {
                        alert("Ajax 失败");
                    }
                })

            }
            websocket.onclose = function(event){
                //更新设备状态为空闲
                let content = JSON.stringify(
                {device_id:device_id, device_ip:ip, idle:"true"}, null, 2
                );
                $.post("/test/device_state", content, function(data, status){
                    if(status === "success"){
                        // console.log(data);
                    } else {
                        alert("Ajax 失败");
                    }
                })
                // 界面置灰
                $("#screen_div").css({ "-webkit-filter": "grayscale(100%)","-moz-filter": "grayscale(100%)","-ms-filter": "grayscale(100%)","-o-filter": "grayscale(100%)","filter": "grayscale(100%)","filter": "gray"})
                isActive = false;
                console.log("******websocket服务关闭*******");
            }
            websocket.onmessage = function(event) {
                //onmessage事件，接收消息
                let msg = event.data;
                // console.log("接受消息==========");
                // let msg = JSON.parse(event.data);
                if (!isActive){
                    isActive = true;
                    $("#screen_div").css({ "-webkit-filter": "","-moz-filter": "","-ms-filter": "","-o-filter": "","filter": ""})
                }
                if (msg.startsWith("*start*")) {
                    base64Str = "";
                    if (msg.endsWith("landscape")){
                        imgWidth = 'width:140%';
                    } else {
                        imgWidth = 'width:100%';
                    }
                } else if (msg == "*end*") {
                    if (base64Str.length > 100) {
                        $("#screen_div").html(`<div style=${imgWidth}><img onmouseover="this.style.cursor='pointer'" id="screen_shot" draggable="false" class="device-screen" src='data:image/png;base64,${base64Str}' style="width: 100%; border: 5px solid rgb(0, 0, 0);border-radius: 20px "></div>`)
                    }
                    send("screen", "");

                } else if (msg.startsWith("*pause*")) {
                    send("screen", "");
                } else if (msg === "*dump_finish*"){
                    $(".dump-screen").load("/test/device_dump?device_id=" + device_id)
                } else if (msg.startsWith("*activity*")) {
                    $("#activity").val(msg.substring(10));

                }else {
                    base64Str += msg;
                }
            }
        } else {
            alert("当前浏览器不支持websocket");
        }
    }

    /*
    websocket消息发送
    */
    function send(mode, param) {
        let msg = {mode: mode, param:param};
        if (websocket.readyState == 1) { //判断连接是否为open状态
            websocket.send(JSON.stringify(msg));
            console.log("发送消息："+JSON.stringify(msg));
        }
    }

    /*
    计算相对坐标
     */
    function getRelativePoint(){
            let screen_div = document.getElementById("screen_shot").getBoundingClientRect();
            let left = screen_div.left;
            let top = screen_div.top;
            let right = screen_div.right;
            let bottom = screen_div.bottom;
            let x=window.event.clientX;//取得横坐标
            let y=window.event.clientY;//取得纵坐标
            let width = right - left;
            let height = bottom - top;
            let relative_x = ((x - left)/width).toFixed(2);
            let relative_y = ((y - top)/height).toFixed(2);
            return [relative_x, relative_y]
        }
    /*
    解析操作类型
     */
    function parseAction(sx, sy, ex, ey, duration) {
            if (Math.abs(sx-ex) < 0.01 && Math.abs(sy-ey) < 0.01){
                if (duration > 1500){
                    return {"click":[sx, sy], "long": duration}
                } else {
                    return {"click": [sx, sy]}
                }
            } else {
                return {"swipe":[sx, sy, ex, ey, duration]}
            }

    }
    /*
    解析界面
     */
    function dumpAction() {
        let ht = $(".left_block").outerHeight();
        if (ht < 500){
            ht = 700
        }
        $(".dump-screen").html('<img style="text-align: center; margin: auto" src="/statics/loading.svg">')
        $(".dump-screen").css({"height": ht + "px", "border":"3px solid #000", "display": "flex", "justify-content:center":"center", "align-items":"center"});

         send("dump","");
    }

    /*
    按键操作
     */
    function clickBtn(key) {
            if (key === "unlock"){
                send("action", {"unlock": "0000"});
            } else {
                send("action", {"press": key});
            }
    }

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null)
            return unescape(r[2]);
        return null;
}
</script>
{% end %}
</body>
</html>

